# Max Turns: Loop exits when iteration limit is reached
#
# Tests the max_turns safeguard:
# 1. LLM keeps calling tools on each iteration
# 2. Loop continues until max_turns is reached
# 3. max_turns_notification is shown
#
# This verifies the runaway prevention mechanism works.

name: max_turns
description: Loop exits when max_turns limit is reached

inputs:
  max_turns: 3  # Low limit for testing

events:
  # Iteration 0: LLM calls tools
  - node: agent_loop.call_llm
    type: llm_response
    text: "Working on it..."
    tool_calls:
      - name: bash
        input:
          command: "step 1"
  - node: agent_loop.execute_tools
    type: tool_result
    tool: bash
    output:
      result: "step 1 done"

  # Iteration 1: LLM calls tools again
  - node: agent_loop.call_llm
    type: llm_response
    text: "Still working..."
    tool_calls:
      - name: bash
        input:
          command: "step 2"
  - node: agent_loop.execute_tools
    type: tool_result
    tool: bash
    output:
      result: "step 2 done"

  # Iteration 2: LLM calls tools (this will be the last iteration at max_turns=3)
  # Loop condition: iter.iteration < max_turns (iter.iteration is already incremented before while check)
  # At iter.iteration=3: 3 is NOT < 3, so loop exits after 3 iterations
  - node: agent_loop.call_llm
    type: llm_response
    text: "Almost there..."
    tool_calls:
      - name: bash
        input:
          command: "step 3"
  - node: agent_loop.execute_tools
    type: tool_result
    tool: bash
    output:
      result: "step 3 done"

expect:
  outcome: completed
  reached:
    - agent_loop
    - agent_loop.call_llm
    - agent_loop.execute_tools
    - max_turns_notification  # Should show max turns warning
  not_reached:
    - agent_loop.approval
