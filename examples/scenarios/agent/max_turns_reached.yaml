# Max turns limit reached - verify loop completes with correct iteration count
name: max_turns_reached
description: Loop hits max_turns limit (verifies iterations output)
inputs:
  mode: auto
  max_turns: 2
events:
  # Iteration 0: tool call
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Searching..."
      response_text: "Searching..."
      tool_calls:
        - id: call_0
          name: grep
          input:
            pattern: "TODO"
  - node: agent_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_0
          content: '["file1.go"]'
      thread_token_count: 500
  # Iteration 1: still wants more tools (hits max_turns=2, iteration < 2 is still true)
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Reading file..."
      response_text: "Reading file..."
      tool_calls:
        - id: call_1
          name: view
          input:
            file_path: "file1.go"
  - node: agent_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_1
          content: "// TODO: fix this"
      thread_token_count: 600
  # max_turns_notification fires because iterations >= max_turns (2 >= 2)
  - node: max_turns_notification
    output:
      message:
        role: system
        text: "Agent reached maximum iteration limit (2 turns)."
expect:
  outcome: completed
  reached:
    - agent_loop
    - agent_loop.call_llm
    - agent_loop.execute_tools
    - max_turns_notification
  not_reached:
    - agent_loop.approval
  # Verify loop outputs _iterations = 2 (exactly hit max_turns)
  node_outputs:
    agent_loop:
      _iterations: 2
