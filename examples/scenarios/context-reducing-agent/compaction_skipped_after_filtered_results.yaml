# Compaction skipped after filtered results when token count is below threshold
name: compaction_skipped_after_filtered_results
description: Token count stays below compaction_threshold after saving filtered results, compact is not reached
inputs:
  mode: "auto"
  compaction_threshold: 185000
events:
  # LLM requests a tool
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Let me analyze that file."
      response_text: "Let me analyze that file."
      tool_calls:
        - id: call_0
          name: view
          input:
            file_path: "large.go"
  # Large tool result triggers filtering
  - node: agent_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_0
          content: "Very long content that exceeds 4000 chars..."
      total_result_chars: 5000
      thread_token_count: 1000
  # Filter LLM evaluates the result
  - node: agent_loop.filter_results
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_1
          name: filtered_results
          input:
            results:
              - tool_call_id: "call_0"
                name: "view"
                filtered: true
                content: "Contains Go code with multiple functions."
                is_error: false
  # Execute filter tool
  - node: agent_loop.execute_filter
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_1
          content: '{"results": [{"tool_call_id": "call_0", "filtered": true, "content": "Contains Go code with multiple functions."}]}'
      response_data:
        filtered_results:
          results:
            - tool_call_id: "call_0"
              name: "view"
              filtered: true
              content: "Contains Go code with multiple functions."
              is_error: false
      thread_token_count: 1200
  # Compact is skipped (token count 1200 < threshold 185000), next iteration starts
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Analysis complete."
      response_text: "Analysis complete."
      tool_calls: []
expect:
  outcome: completed
  reached:
    - agent_loop
    - agent_loop.call_llm
    - agent_loop.execute_tools
    - agent_loop.filter_results
    - agent_loop.execute_filter
    - agent_loop.save_filtered_results
  not_reached:
    - agent_loop.compact
    - agent_loop.save_tool_results
