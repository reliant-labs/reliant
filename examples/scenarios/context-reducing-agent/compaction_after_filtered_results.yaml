# Compaction triggered after filtered results
name: compaction_after_filtered_results
description: High token count triggers compaction after saving filtered results
inputs:
  mode: "auto"
  compaction_threshold: 10000
events:
  # LLM requests a tool
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Searching..."
      response_text: "Searching..."
      tool_calls:
        - id: call_0
          name: grep
          input:
            pattern: "error"
            path: "."
  # Large result triggers filtering
  - node: agent_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_0
          content: "many errors..."
      total_result_chars: 6000
      thread_token_count: 15000
  # filter_results LLM
  - node: agent_loop.filter_results
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_1
          name: filtered_results
          input:
            results:
              - tool_call_id: "call_0"
                name: "grep"
                filtered: true
                content: "5 critical errors found"
                is_error: false
  # execute_filter result
  - node: agent_loop.execute_filter
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_1
          content: '{"results": [{"tool_call_id": "call_0", "filtered": true, "content": "5 critical errors found"}]}'
      response_data:
        filtered_results:
          results:
            - tool_call_id: "call_0"
              name: "grep"
              filtered: true
              content: "5 critical errors found"
              is_error: false
      thread_token_count: 15000
  # Final response
  - node: agent_loop.call_llm
    output:
      message:
        role: assistant
        text: "Found 5 critical errors."
      response_text: "Found 5 critical errors."
      tool_calls: []
expect:
  outcome: completed
  reached:
    - agent_loop
    - agent_loop.call_llm
    - agent_loop.execute_tools
    - agent_loop.filter_results
    - agent_loop.execute_filter
    - agent_loop.save_filtered_results
    - agent_loop.compact
