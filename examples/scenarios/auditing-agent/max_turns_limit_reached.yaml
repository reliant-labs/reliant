# Max turns limit scenario - loop exits when iteration limit reached
name: max_turns_limit_reached
description: Loop exits when iter.iteration reaches inputs.agent.max_turns
inputs:
  agent:
    max_turns: 2
events:
  # Iteration 1: main_agent makes a tool call
  - node: audited_loop.main_agent
    output:
      message:
        role: assistant
        text: "Let me search for files."
      response_text: "Let me search for files."
      tool_calls:
        - id: call_0
          name: grep
          input:
            pattern: "TODO"
            path: "."
  - node: audited_loop.audit_check
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_1
          name: audit
          input:
            approved: true
            guidance: ""
  - node: audited_loop.execute_audit
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_1
          content: '{"approved": true}'
      response_data:
        audit:
          approved: true
          guidance: ""
      thread_token_count: 500
  - node: audited_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_0
          content: '["main.go:10"]'
      thread_token_count: 600
  # Iteration 2 (max_turns=2, so this is the last allowed iteration)
  - node: audited_loop.main_agent
    output:
      message:
        role: assistant
        text: "Found it. Let me read the file."
      response_text: "Found it. Let me read the file."
      tool_calls:
        - id: call_2
          name: view
          input:
            file_path: "main.go"
  - node: audited_loop.audit_check
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_3
          name: audit
          input:
            approved: true
            guidance: ""
  - node: audited_loop.execute_audit
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_3
          content: '{"approved": true}'
      response_data:
        audit:
          approved: true
          guidance: ""
      thread_token_count: 500
  - node: audited_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_2
          content: "package main"
      thread_token_count: 700
  # Loop exits after iteration 2 because iter.iteration (2) is no longer < max_turns (2)
expect:
  outcome: completed
  reached:
    - audited_loop
    - audited_loop.main_agent
    - audited_loop.audit_check
    - audited_loop.execute_audit
    - audited_loop.save_approved_response
    - audited_loop.execute_tools
