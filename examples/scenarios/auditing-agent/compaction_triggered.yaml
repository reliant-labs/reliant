# Compaction triggered when token count exceeds threshold
name: compaction_triggered
description: Token count exceeds compaction_threshold, compact node runs
inputs:
  agent:
    compaction_threshold: 1000
events:
  # main_agent requests a tool
  - node: audited_loop.main_agent
    output:
      message:
        role: assistant
        text: "Let me read that large file."
      response_text: "Let me read that large file."
      tool_calls:
        - id: call_0
          name: view
          input:
            file_path: "/path/to/large_file.go"
  # audit_check approves
  - node: audited_loop.audit_check
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_1
          name: audit
          input:
            approved: true
            guidance: ""
  # execute_audit result
  - node: audited_loop.execute_audit
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_1
          content: '{"approved": true}'
      response_data:
        audit:
          approved: true
          guidance: ""
      thread_token_count: 500
  # execute_tools returns large result, token count exceeds threshold
  - node: audited_loop.execute_tools
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_0
          content: "Very long file content that causes context to grow..."
      thread_token_count: 5000
  # Compact runs because thread_token_count (5000) > compaction_threshold (1000)
  - node: audited_loop.compact
    output:
      message:
        role: assistant
        text: "Context compacted."
  # Next iteration: main_agent responds with final answer
  - node: audited_loop.main_agent
    output:
      message:
        role: assistant
        text: "The file contains Go code."
      response_text: "The file contains Go code."
      tool_calls: []
  # audit_check approves final response
  - node: audited_loop.audit_check
    output:
      message:
        role: assistant
        text: ""
      response_text: ""
      tool_calls:
        - id: call_2
          name: audit
          input:
            approved: true
            guidance: ""
  - node: audited_loop.execute_audit
    output:
      message:
        role: tool
        text: ""
      tool_results:
        - tool_call_id: call_2
          content: '{"approved": true}'
      response_data:
        audit:
          approved: true
          guidance: ""
      thread_token_count: 1500
expect:
  outcome: completed
  reached:
    - audited_loop
    - audited_loop.main_agent
    - audited_loop.audit_check
    - audited_loop.execute_audit
    - audited_loop.save_approved_response
    - audited_loop.execute_tools
    - audited_loop.compact
